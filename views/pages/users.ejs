<%- include('../components/header', { pageTitle: 'Manage Users' }) %>

<div class="page-intro">
  <div class="intro-content">
    <div class="intro-icon">
      <i class="fas fa-users"></i>
    </div>
    <div class="intro-text">
      <h2>Manage Users</h2>
      <p>View, add, edit, and manage all system users</p>
    </div>
  </div>
  <div class="intro-actions">
    <a href="/admin/users/create" class="btn btn-primary">
      <i class="fas fa-user-plus"></i> Add New User
    </a>
  </div>
</div>

<!-- User Stats Overview -->
<div class="row mb-4">
  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card shadow-sm stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon bg-primary">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content ms-3">
          <h6 class="stat-title text-muted mb-1">Total Users</h6>
          <div class="stat-value fs-4 fw-bold"><%= users.length %></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card shadow-sm stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon bg-success">
          <i class="fas fa-user-check"></i>
        </div>
        <div class="stat-content ms-3">
          <h6 class="stat-title text-muted mb-1">Active Users</h6>
          <div class="stat-value fs-4 fw-bold">
            <%= users.filter(user => user.isActive).length %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card shadow-sm stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon bg-info">
          <i class="fas fa-user-shield"></i>
        </div>
        <div class="stat-content ms-3">
          <h6 class="stat-title text-muted mb-1">Administrators</h6>
          <div class="stat-value fs-4 fw-bold">
            <%= users.filter(user => user.role === 'admin').length %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-xl-3 col-md-6 mb-3">
    <div class="card shadow-sm stat-card">
      <div class="card-body d-flex align-items-center">
        <div class="stat-icon bg-warning">
          <i class="fas fa-user-edit"></i>
        </div>
        <div class="stat-content ms-3">
          <h6 class="stat-title text-muted mb-1">Editors</h6>
          <div class="stat-value fs-4 fw-bold">
            <%= users.filter(user => user.role === 'editor').length %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-light">
    <div class="d-flex flex-wrap justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-filter me-2"></i> Filter and Search</h5>
      <button
        id="toggleFilters"
        class="btn btn-sm btn-outline-secondary d-md-none"
      >
        <i class="fas fa-sliders-h"></i> Toggle Filters
      </button>
    </div>
  </div>
  <div class="card-body filter-section" id="filterSection">
    <div class="row g-3">
      <div class="col-lg-4 col-md-6">
        <label for="userSearchInput" class="form-label small text-muted"
          >Search</label
        >
        <div class="input-group">
          <span class="input-group-text bg-light"
            ><i class="fas fa-search"></i
          ></span>
          <input
            type="text"
            id="userSearchInput"
            class="form-control"
            placeholder="Search by name or email..."
          />
          <button
            class="btn btn-outline-secondary"
            type="button"
            id="clearSearchBtn"
            title="Clear search"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="col-lg-2 col-md-6">
        <label for="roleFilter" class="form-label small text-muted">Role</label>
        <select id="roleFilter" class="form-select">
          <option value="">All Roles</option>
          <option value="admin">Administrators</option>
          <option value="editor">Editors</option>
        </select>
      </div>
      <div class="col-lg-2 col-md-6">
        <label for="statusFilter" class="form-label small text-muted"
          >Status</label
        >
        <select id="statusFilter" class="form-select">
          <option value="">All Status</option>
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>
      <div class="col-lg-2 col-md-6">
        <label for="sortOrder" class="form-label small text-muted"
          >Sort By</label
        >
        <select id="sortOrder" class="form-select">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="nameAsc">Name (A-Z)</option>
          <option value="nameDesc">Name (Z-A)</option>
          <option value="lastLogin">Last Login</option>
        </select>
      </div>
      <div class="col-lg-2 d-flex align-items-end">
        <button id="clearFiltersBtn" class="btn btn-outline-secondary w-100">
          <i class="fas fa-eraser me-1"></i> Clear Filters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loader for AJAX operations -->
<div id="loadingOverlay" class="loading-overlay d-none">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div
    class="card-header bg-light d-flex justify-content-between align-items-center py-3"
  >
    <h5 class="mb-0"><i class="fas fa-table me-2"></i> User Accounts</h5>
    <span class="badge bg-primary" id="userCount"
      ><%= users.length %> Users</span
    >
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover user-table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th width="40" class="ps-3">#</th>
            <th width="50"></th>
            <th>Name</th>
            <th>Email</th>
            <th width="130">Role</th>
            <th width="100">Status</th>
            <th>Last Login</th>
            <th width="150" class="text-end pe-3">Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          <% users.forEach((user, index) => { %>
          <tr
            data-id="<%= user._id %>"
            data-role="<%= user.role %>"
            data-active="<%= user.isActive %>"
            data-created-at="<%= user.createdAt %>"
            data-name="<%= user.name %>"
            data-email="<%= user.email %>"
            class="user-row"
          >
            <td class="ps-3"><%= index + 1 %></td>
            <td>
              <div class="avatar-circle-sm">
                <span class="avatar-initials-sm"
                  ><%= user.name.charAt(0).toUpperCase() %></span
                >
              </div>
            </td>
            <td>
              <div class="d-flex flex-column">
                <div class="fw-medium text-truncate" style="max-width: 180px">
                  <%= user.name %>
                </div>
                <small
                  class="text-muted d-md-none text-truncate"
                  style="max-width: 180px"
                  ><%= user.email %></small
                >
              </div>
            </td>
            <td class="d-none d-md-table-cell">
              <div class="text-muted text-truncate" style="max-width: 230px">
                <%= user.email %>
              </div>
            </td>
            <td>
              <span
                class="badge rounded-pill <%= user.role === 'admin' ? 'bg-primary' : 'bg-info' %>"
              >
                <i
                  class="fas <%= user.role === 'admin' ? 'fa-user-shield' : 'fa-user-edit' %> me-1"
                ></i>
                <%= user.role === 'admin' ? 'Administrator' : 'Editor' %>
              </span>
            </td>
            <td>
              <div class="form-check form-switch">
                <input class="form-check-input status-toggle" type="checkbox"
                id="status-<%= user._id %>" <%= user.isActive ? 'checked' : ''
                %> <%= user._id.toString() === currentUser._id.toString() ?
                'disabled' : '' %> data-id="<%= user._id %>" data-name="<%=
                user.name %>" >
                <label class="form-check-label" for="status-<%= user._id %>">
                  <span
                    class="status-label <%= user.isActive ? 'text-success' : 'text-secondary' %>"
                  >
                    <%= user.isActive ? 'Active' : 'Inactive' %>
                  </span>
                </label>
              </div>
            </td>
            <td>
              <div
                class="<%= !user.lastLogin ? 'text-muted fst-italic' : '' %>"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="<%= user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Never logged in' %>"
              >
                <%= user.lastLogin ? new Date(user.lastLogin).toLocaleString() :
                'Never' %>
              </div>
            </td>
            <td class="text-end pe-3">
              <div class="action-buttons">
                <a
                  href="/admin/users/<%= user._id %>/view"
                  class="btn btn-sm btn-outline-secondary"
                  data-bs-toggle="tooltip"
                  title="View Profile"
                >
                  <i class="fas fa-eye"></i>
                </a>
                <a
                  href="/admin/users/<%= user._id %>/edit"
                  class="btn btn-sm btn-outline-primary ms-1"
                  data-bs-toggle="tooltip"
                  title="Edit User"
                >
                  <i class="fas fa-edit"></i>
                </a>
                <% if (user._id.toString() !== currentUser._id.toString()) { %>
                <button
                  class="btn btn-sm btn-outline-danger ms-1 delete-user-btn"
                  data-id="<%= user._id %>"
                  data-name="<%= user.name %>"
                  data-bs-toggle="tooltip"
                  title="Delete User"
                >
                  <i class="fas fa-trash"></i>
                </button>
                <% } %>
              </div>
            </td>
          </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <% if (users.length === 0) { %>
    <div class="empty-state text-center py-5">
      <div class="empty-state-icon">
        <i class="fas fa-users"></i>
      </div>
      <h3>No Users Found</h3>
      <p class="text-muted">No users match your current filters</p>
      <button id="clearFiltersEmptyBtn" class="btn btn-outline-secondary mt-3">
        <i class="fas fa-filter"></i> Clear Filters
      </button>
    </div>
    <% } %>

    <div class="pagination-container p-3 border-top bg-light">
      <div class="d-flex flex-wrap justify-content-between align-items-center">
        <div class="page-info text-muted small mb-2 mb-md-0">
          Showing <span id="startIndex" class="fw-bold">1</span> to
          <span id="endIndex" class="fw-bold"
            ><%= Math.min(10, users.length) %></span
          >
          of
          <span id="totalItems" class="fw-bold"><%= users.length %></span> users
        </div>
        <div>
          <nav aria-label="User pagination">
            <ul class="pagination pagination-sm mb-0" id="pagination">
              <!-- Pagination will be dynamically generated here -->
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete User Confirmation Modal -->
<div
  class="modal fade"
  id="deleteUserModal"
  tabindex="-1"
  aria-labelledby="deleteUserModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteUserModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i> Delete User
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <div class="warning-icon">
            <i class="fas fa-user-slash"></i>
          </div>
        </div>
        <p class="fs-5 text-center">
          Are you sure you want to delete <strong id="deleteUserName"></strong>?
        </p>
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle me-2"></i>
          This action cannot be undone. The user's account will be permanently
          deleted from the system.
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash"></i> Delete User
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast for notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
  <div
    id="notificationToast"
    class="toast align-items-center text-white bg-success border-0"
    role="alert"
    aria-live="assertive"
    aria-atomic="true"
  >
    <div class="d-flex">
      <div class="toast-body">
        <i class="fas fa-check-circle me-2"></i>
        <span id="toastMessage">Operation successful</span>
      </div>
      <button
        type="button"
        class="btn-close btn-close-white me-2 m-auto"
        data-bs-dismiss="toast"
        aria-label="Close"
      ></button>
    </div>
  </div>
</div>

<!-- Status Change Confirmation Modal -->
<div
  class="modal fade"
  id="statusChangeModal"
  tabindex="-1"
  aria-labelledby="statusChangeModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="statusChangeModalLabel">
          <i class="fas fa-exclamation-circle me-2"></i> Confirm Status Change
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p class="fs-5 text-center" id="statusChangeMessage">
          Are you sure you want to change this user's status?
        </p>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
          id="cancelStatusChange"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-warning" id="confirmStatusChange">
          <i class="fas fa-check"></i> Confirm Change
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .page-intro {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    background: linear-gradient(to right, #f8f9fa, #ffffff);
    border-radius: 8px;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border-left: 4px solid var(--primary-color);
  }

  .intro-content {
    display: flex;
    align-items: center;
  }

  .intro-icon {
    font-size: 1.8rem;
    width: 56px;
    height: 56px;
    background: linear-gradient(
      135deg,
      var(--primary-color) 0%,
      var(--bs-primary) 100%
    );
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    box-shadow: 0 0.25rem 0.5rem rgba(var(--primary-color-rgb), 0.2);
    transition: transform 0.3s ease;
  }

  .intro-icon:hover {
    transform: scale(1.05);
  }

  .intro-text h2 {
    margin: 0;
    font-weight: 600;
    color: var(--bs-dark);
  }

  .intro-text p {
    margin: 0.5rem 0 0;
    color: #6c757d;
  }

  .avatar-circle-sm {
    width: 36px;
    height: 36px;
    background: linear-gradient(
      135deg,
      var(--primary-color) 0%,
      var(--bs-primary) 100%
    );
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: transform 0.2s ease;
  }

  .avatar-circle-sm:hover {
    transform: scale(1.1);
  }

  .avatar-initials-sm {
    color: white;
    font-size: 16px;
    font-weight: bold;
    line-height: 1;
  }

  .empty-state {
    padding: 3rem 2rem;
  }

  .empty-state-icon {
    font-size: 3.5rem;
    color: #adb5bd;
    margin-bottom: 1.5rem;
    opacity: 0.7;
  }

  .warning-icon {
    font-size: 3.5rem;
    color: #f8bb86;
    margin-bottom: 1rem;
  }

  .user-table thead th {
    font-weight: 600;
    color: #495057;
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
  }

  .user-table td {
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
  }

  .user-row {
    transition: background-color 0.2s ease;
  }

  .user-row:hover {
    background-color: rgba(var(--bs-primary-rgb), 0.05);
  }

  .action-buttons {
    white-space: nowrap;
  }

  .stat-card {
    transition: transform 0.2s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 0.5rem;
    overflow: hidden;
    height: 100%;
  }

  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }

  .stat-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    border-radius: 12px;
    font-size: 1.25rem;
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  @media (max-width: 992px) {
    .page-intro {
      flex-direction: column;
      align-items: flex-start;
    }

    .intro-actions {
      margin-top: 1rem;
      align-self: flex-start;
    }

    #filterSection {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    #filterSection.show {
      max-height: 1000px;
      transition: max-height 0.5s ease-in;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Variables
    const itemsPerPage = 10;
    let currentPage = 1;
    let filteredUsers = [];
    let statusChangeUserId = null;
    let statusChangeValue = false;

    // Elements
    const userTableBody = document.getElementById("userTableBody");
    const userSearchInput = document.getElementById("userSearchInput");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const roleFilter = document.getElementById("roleFilter");
    const statusFilter = document.getElementById("statusFilter");
    const sortOrder = document.getElementById("sortOrder");
    const clearFiltersBtn = document.getElementById("clearFiltersBtn");
    const clearFiltersEmptyBtn = document.getElementById(
      "clearFiltersEmptyBtn"
    );
    const toggleFiltersBtn = document.getElementById("toggleFilters");
    const filterSection = document.getElementById("filterSection");
    const deleteUserModal = new bootstrap.Modal(
      document.getElementById("deleteUserModal")
    );
    const deleteUserName = document.getElementById("deleteUserName");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const userCount = document.getElementById("userCount");
    const notificationToast = new bootstrap.Toast(
      document.getElementById("notificationToast")
    );
    const toastMessage = document.getElementById("toastMessage");
    const statusChangeModal = new bootstrap.Modal(
      document.getElementById("statusChangeModal")
    );
    const statusChangeMessage = document.getElementById("statusChangeMessage");
    const confirmStatusChange = document.getElementById("confirmStatusChange");
    const cancelStatusChange = document.getElementById("cancelStatusChange");

    // Toggle filters on mobile
    if (toggleFiltersBtn) {
      toggleFiltersBtn.addEventListener("click", function () {
        filterSection.classList.toggle("show");
        this.innerHTML = filterSection.classList.contains("show")
          ? '<i class="fas fa-times"></i> Hide Filters'
          : '<i class="fas fa-sliders-h"></i> Toggle Filters';
      });

      // Show filters by default on desktop
      if (window.innerWidth >= 768) {
        filterSection.classList.add("show");
      }
    }

    // Get all user rows
    const allUserRows = Array.from(userTableBody.querySelectorAll("tr"));
    filteredUsers = [...allUserRows];

    // Initialize pagination
    updatePagination();

    // Search functionality
    userSearchInput.addEventListener("input", function () {
      applyFilters();
    });

    // Clear search
    clearSearchBtn.addEventListener("click", function () {
      userSearchInput.value = "";
      applyFilters();
    });

    // Role filter
    roleFilter.addEventListener("change", function () {
      applyFilters();
    });

    // Status filter
    statusFilter.addEventListener("change", function () {
      applyFilters();
    });

    // Sort order
    sortOrder.addEventListener("change", function () {
      applyFilters();
    });

    // Clear filters
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener("click", function () {
        clearAllFilters();
      });
    }

    // Clear filters from empty state
    if (clearFiltersEmptyBtn) {
      clearFiltersEmptyBtn.addEventListener("click", function () {
        clearAllFilters();
      });
    }

    // Status toggle switches
    document.addEventListener("change", function (e) {
      if (e.target.classList.contains("status-toggle")) {
        const userId = e.target.getAttribute("data-id");
        const userName = e.target.getAttribute("data-name");
        const newStatus = e.target.checked;

        // Store for confirmation
        statusChangeUserId = userId;
        statusChangeValue = newStatus;

        // Reset checkbox to original value until confirmed
        e.target.checked = !newStatus;

        // Update confirmation message
        statusChangeMessage.innerHTML = `Are you sure you want to ${
          newStatus ? "activate" : "deactivate"
        } <strong>${userName}</strong>'s account?`;

        // Show confirmation modal
        statusChangeModal.show();
      }
    });

    // Confirm status change
    confirmStatusChange.addEventListener("click", async function () {
      if (!statusChangeUserId) return;

      try {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        loadingOverlay.classList.remove("d-none");

        const response = await fetch(`/api/auth/users/${statusChangeUserId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ isActive: statusChangeValue }),
        });

        const data = await response.json();

        if (data.success) {
          // Update UI
          const statusToggle = document.getElementById(
            `status-${statusChangeUserId}`
          );
          const statusLabel =
            statusToggle.nextElementSibling.querySelector(".status-label");

          statusToggle.checked = statusChangeValue;
          statusLabel.textContent = statusChangeValue ? "Active" : "Inactive";
          statusLabel.className = `status-label ${
            statusChangeValue ? "text-success" : "text-secondary"
          }`;

          // Update row data attribute
          const userRow = document.querySelector(
            `tr[data-id="${statusChangeUserId}"]`
          );
          userRow.setAttribute("data-active", statusChangeValue);

          // Show success notification
          toastMessage.textContent = `User has been ${
            statusChangeValue ? "activated" : "deactivated"
          } successfully`;
          document
            .getElementById("notificationToast")
            .classList.remove("bg-success", "bg-danger");
          document
            .getElementById("notificationToast")
            .classList.add("bg-success");
          notificationToast.show();

          // Reapply filters
          applyFilters();
        } else {
          // Show error notification
          toastMessage.textContent =
            data.message || "Failed to update user status";
          document
            .getElementById("notificationToast")
            .classList.remove("bg-success", "bg-danger");
          document
            .getElementById("notificationToast")
            .classList.add("bg-danger");
          notificationToast.show();
        }
      } catch (error) {
        console.error("Error:", error);
        toastMessage.textContent =
          "An error occurred while updating user status";
        document
          .getElementById("notificationToast")
          .classList.remove("bg-success", "bg-danger");
        document.getElementById("notificationToast").classList.add("bg-danger");
        notificationToast.show();
      } finally {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-check"></i> Confirm Change';
        loadingOverlay.classList.add("d-none");
        statusChangeModal.hide();
      }
    });

    // Cancel status change
    cancelStatusChange.addEventListener("click", function () {
      statusChangeUserId = null;
      statusChangeValue = false;
    });

    // Function to clear all filters
    function clearAllFilters() {
      userSearchInput.value = "";
      roleFilter.value = "";
      statusFilter.value = "";
      sortOrder.value = "newest";
      applyFilters();

      // Show toast notification
      toastMessage.textContent = "All filters have been cleared";
      document
        .getElementById("notificationToast")
        .classList.remove("bg-success", "bg-danger");
      document.getElementById("notificationToast").classList.add("bg-success");
      notificationToast.show();
    }

    // Delete user buttons - using direct event assignment instead of delegation
    document.querySelectorAll(".delete-user-btn").forEach((button) => {
      button.addEventListener("click", function () {
        const userId = this.getAttribute("data-id");
        const name = this.getAttribute("data-name");

        deleteUserName.textContent = name;
        confirmDeleteBtn.setAttribute("data-id", userId);

        deleteUserModal.show();
      });
    });

    // Confirm delete
    confirmDeleteBtn.addEventListener("click", async function () {
      const userId = this.getAttribute("data-id");

      try {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
        loadingOverlay.classList.remove("d-none");

        const response = await fetch(`/api/auth/users/${userId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        });

        const data = await response.json();

        if (data.success) {
          deleteUserModal.hide();

          // Show success notification
          toastMessage.textContent = "User has been deleted successfully";
          document
            .getElementById("notificationToast")
            .classList.remove("bg-success", "bg-danger");
          document
            .getElementById("notificationToast")
            .classList.add("bg-success");
          notificationToast.show();

          // Remove the user row from the table with animation
          const row = document.querySelector(`tr[data-id="${userId}"]`);
          if (row) {
            // Add fade-out animation
            row.style.transition = "all 0.5s";
            row.style.opacity = "0";
            row.style.transform = "translateX(20px)";

            setTimeout(() => {
              row.remove();

              // Update filtered users and pagination
              const index = allUserRows.findIndex(
                (r) => r.getAttribute("data-id") === userId
              );
              if (index !== -1) {
                allUserRows.splice(index, 1);
                applyFilters();

                // Update user count
                userCount.textContent = `${allUserRows.length} Users`;
              }
            }, 500);
          }
        } else {
          // Show error notification
          toastMessage.textContent = data.message || "Failed to delete user";
          document
            .getElementById("notificationToast")
            .classList.remove("bg-success", "bg-danger");
          document
            .getElementById("notificationToast")
            .classList.add("bg-danger");
          notificationToast.show();
        }
      } catch (error) {
        console.error("Error:", error);

        // Show error notification
        toastMessage.textContent = "An error occurred while deleting the user";
        document
          .getElementById("notificationToast")
          .classList.remove("bg-success", "bg-danger");
        document.getElementById("notificationToast").classList.add("bg-danger");
        notificationToast.show();
      } finally {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-trash"></i> Delete User';
        loadingOverlay.classList.add("d-none");
      }
    });

    // Apply filters function
    function applyFilters() {
      const searchTerm = userSearchInput.value.toLowerCase();
      const roleValue = roleFilter.value;
      const statusValue = statusFilter.value;
      const sortValue = sortOrder.value;

      // Show loading state
      loadingOverlay.classList.remove("d-none");

      // Filter users
      filteredUsers = allUserRows.filter((row) => {
        const userName = row.getAttribute("data-name").toLowerCase();
        const userEmail = row.getAttribute("data-email").toLowerCase();
        const userRole = row.getAttribute("data-role");
        const userActive = row.getAttribute("data-active");

        const matchesSearch =
          searchTerm === "" ||
          userName.includes(searchTerm) ||
          userEmail.includes(searchTerm);

        const matchesRole = roleValue === "" || userRole === roleValue;

        const matchesStatus = statusValue === "" || userActive === statusValue;

        return matchesSearch && matchesRole && matchesStatus;
      });

      // Sort users
      filteredUsers.sort((a, b) => {
        const aName = a.getAttribute("data-name").trim();
        const bName = b.getAttribute("data-name").trim();
        const aCreatedAt = new Date(a.getAttribute("data-created-at") || 0);
        const bCreatedAt = new Date(b.getAttribute("data-created-at") || 0);
        const aLastLogin = a
          .querySelector("td:nth-child(7) div")
          .textContent.trim();
        const bLastLogin = b
          .querySelector("td:nth-child(7) div")
          .textContent.trim();

        switch (sortValue) {
          case "nameAsc":
            return aName.localeCompare(bName);
          case "nameDesc":
            return bName.localeCompare(aName);
          case "oldest":
            return aCreatedAt - bCreatedAt;
          case "lastLogin":
            // Handle "Never" special case
            if (aLastLogin === "Never" && bLastLogin === "Never") return 0;
            if (aLastLogin === "Never") return 1;
            if (bLastLogin === "Never") return -1;
            return new Date(bLastLogin) - new Date(aLastLogin);
          case "newest":
          default:
            return bCreatedAt - aCreatedAt;
        }
      });

      // Reset to first page
      currentPage = 1;

      // Update UI
      updateTable();
      updatePagination();

      // Update filter indicators
      updateFilterIndicators();

      // Hide loading after a short delay for better UX
      setTimeout(() => {
        loadingOverlay.classList.add("d-none");
      }, 300);
    }

    // Update filter indicators
    function updateFilterIndicators() {
      // Count active filters
      let activeFilterCount = 0;
      if (userSearchInput.value) activeFilterCount++;
      if (roleFilter.value) activeFilterCount++;
      if (statusFilter.value) activeFilterCount++;
      if (sortOrder.value !== "newest") activeFilterCount++;

      // Show count on clear filters button
      if (activeFilterCount > 0) {
        clearFiltersBtn.innerHTML = `<i class="fas fa-eraser me-1"></i> Clear Filters (${activeFilterCount})`;
        clearFiltersBtn.classList.remove("btn-outline-secondary");
        clearFiltersBtn.classList.add("btn-secondary");
      } else {
        clearFiltersBtn.innerHTML = `<i class="fas fa-eraser me-1"></i> Clear Filters`;
        clearFiltersBtn.classList.remove("btn-secondary");
        clearFiltersBtn.classList.add("btn-outline-secondary");
      }
    }

    // Update table with current page data
    function updateTable() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(
        startIndex + itemsPerPage,
        filteredUsers.length
      );

      // Clear table
      userTableBody.innerHTML = "";

      // Show empty state if no users match filters
      const emptyState = document.querySelector(".empty-state");
      if (filteredUsers.length === 0 && emptyState) {
        emptyState.style.display = "block";
      } else if (emptyState) {
        emptyState.style.display = "none";
      }

      // Add visible rows
      for (let i = startIndex; i < endIndex; i++) {
        const row = filteredUsers[i].cloneNode(true);
        row.cells[0].textContent = i + 1; // Update row number

        // Reattach event listeners for the new rows
        const deleteBtn = row.querySelector(".delete-user-btn");
        if (deleteBtn) {
          deleteBtn.addEventListener("click", function () {
            const userId = this.getAttribute("data-id");
            const name = this.getAttribute("data-name");

            deleteUserName.textContent = name;
            confirmDeleteBtn.setAttribute("data-id", userId);

            deleteUserModal.show();
          });
        }

        userTableBody.appendChild(row);
      }

      // Reinitialize tooltips after table update
      const newTooltips = [].slice.call(
        userTableBody.querySelectorAll('[data-bs-toggle="tooltip"]')
      );
      newTooltips.forEach(function (tooltip) {
        new bootstrap.Tooltip(tooltip);
      });

      // Update page info
      document.getElementById("startIndex").textContent =
        filteredUsers.length > 0 ? startIndex + 1 : 0;
      document.getElementById("endIndex").textContent = endIndex;
      document.getElementById("totalItems").textContent = filteredUsers.length;
    }

    // Update pagination
    function updatePagination() {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";

      const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);

      // Previous button
      const prevLi = document.createElement("li");
      prevLi.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
      prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
      </a>`;
      prevLi.addEventListener("click", function (e) {
        e.preventDefault();
        if (currentPage > 1) {
          currentPage--;
          updateTable();
          updatePagination();
        }
      });
      pagination.appendChild(prevLi);

      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(
        1,
        currentPage - Math.floor(maxVisiblePages / 2)
      );
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      // First page and ellipsis
      if (startPage > 1) {
        const firstPageLi = document.createElement("li");
        firstPageLi.className = "page-item";
        firstPageLi.innerHTML = '<a class="page-link" href="#">1</a>';
        firstPageLi.addEventListener("click", function (e) {
          e.preventDefault();
          currentPage = 1;
          updateTable();
          updatePagination();
        });
        pagination.appendChild(firstPageLi);

        if (startPage > 2) {
          const ellipsisLi = document.createElement("li");
          ellipsisLi.className = "page-item disabled";
          ellipsisLi.innerHTML = '<a class="page-link" href="#">...</a>';
          pagination.appendChild(ellipsisLi);
        }
      }

      // Visible page numbers
      for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement("li");
        pageLi.className = `page-item ${i === currentPage ? "active" : ""}`;
        pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        pageLi.addEventListener("click", function (e) {
          e.preventDefault();
          currentPage = i;
          updateTable();
          updatePagination();
        });
        pagination.appendChild(pageLi);
      }

      // Last page and ellipsis
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsisLi = document.createElement("li");
          ellipsisLi.className = "page-item disabled";
          ellipsisLi.innerHTML = '<a class="page-link" href="#">...</a>';
          pagination.appendChild(ellipsisLi);
        }

        const lastPageLi = document.createElement("li");
        lastPageLi.className = "page-item";
        lastPageLi.innerHTML = `<a class="page-link" href="#">${totalPages}</a>`;
        lastPageLi.addEventListener("click", function (e) {
          e.preventDefault();
          currentPage = totalPages;
          updateTable();
          updatePagination();
        });
        pagination.appendChild(lastPageLi);
      }

      // Next button
      const nextLi = document.createElement("li");
      nextLi.className = `page-item ${
        currentPage === totalPages ? "disabled" : ""
      }`;
      nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
      </a>`;
      nextLi.addEventListener("click", function (e) {
        e.preventDefault();
        if (currentPage < totalPages) {
          currentPage++;
          updateTable();
          updatePagination();
        }
      });
      pagination.appendChild(nextLi);
    }
  });
</script>

<%- include('../components/footer') %>
