<%- include('../components/header', { pageTitle: 'View User' }) %>

<div class="page-intro">
  <div class="intro-content">
    <div class="intro-icon">
      <i class="fas fa-user"></i>
    </div>
    <div class="intro-text">
      <h2>View User Profile</h2>
      <p>Viewing details for <%= userToView.name %></p>
    </div>
  </div>
  <div class="intro-actions">
    <a href="/admin/users" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left"></i> Back to Users
    </a>
    <% if (userToView._id.toString() !== currentUser._id.toString()) { %>
    <a
      href="/admin/users/<%= userToView._id %>/edit"
      class="btn btn-primary ms-2"
    >
      <i class="fas fa-edit"></i> Edit User
    </a>
    <% } %>
  </div>
</div>

<div class="row">
  <div class="col-lg-4 mb-4">
    <div class="card shadow-sm h-100">
      <div class="card-body text-center">
        <div class="avatar-circle mb-4 mx-auto">
          <span class="avatar-initials"
            ><%= userToView.name.charAt(0).toUpperCase() %></span
          >
        </div>
        <h4 class="mb-1"><%= userToView.name %></h4>
        <p class="text-muted mb-3">
          <i class="fas fa-envelope me-2"></i><%= userToView.email %>
        </p>
        <span
          class="badge rounded-pill bg-<%= userToView.role === 'admin' ? 'primary' : 'info' %> mb-2"
        >
          <i
            class="fas <%= userToView.role === 'admin' ? 'fa-user-shield' : 'fa-user-edit' %> me-1"
          ></i>
          <%= userToView.role === 'admin' ? 'Administrator' : 'Editor' %>
        </span>
        <span
          class="badge rounded-pill bg-<%= userToView.isActive ? 'success' : 'secondary' %>"
        >
          <i
            class="fas <%= userToView.isActive ? 'fa-check-circle' : 'fa-times-circle' %> me-1"
          ></i>
          <%= userToView.isActive ? 'Active' : 'Inactive' %>
        </span>
      </div>
      <div class="card-footer bg-light">
        <div class="row text-center">
          <div class="col-6 border-end">
            <div class="py-2">
              <h6 class="mb-0">Created</h6>
              <small class="text-muted"
                ><%= new Date(userToView.createdAt).toLocaleDateString()
                %></small
              >
            </div>
          </div>
          <div class="col-6">
            <div class="py-2">
              <h6 class="mb-0">Last Login</h6>
              <small class="text-muted"
                ><%= userToView.lastLogin ? new
                Date(userToView.lastLogin).toLocaleDateString() : 'Never'
                %></small
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light">
        <h5 class="mb-0">
          <i class="fas fa-info-circle me-2"></i> User Information
        </h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-4 fw-bold">Full Name</div>
          <div class="col-md-8"><%= userToView.name %></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4 fw-bold">Email Address</div>
          <div class="col-md-8"><%= userToView.email %></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4 fw-bold">Account Type</div>
          <div class="col-md-8">
            <span
              class="badge rounded-pill bg-<%= userToView.role === 'admin' ? 'primary' : 'info' %>"
            >
              <i
                class="fas <%= userToView.role === 'admin' ? 'fa-user-shield' : 'fa-user-edit' %> me-1"
              ></i>
              <%= userToView.role === 'admin' ? 'Administrator' : 'Editor' %>
            </span>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4 fw-bold">Account Status</div>
          <div class="col-md-8">
            <span
              class="badge rounded-pill bg-<%= userToView.isActive ? 'success' : 'secondary' %>"
            >
              <i
                class="fas <%= userToView.isActive ? 'fa-check-circle' : 'fa-times-circle' %> me-1"
              ></i>
              <%= userToView.isActive ? 'Active' : 'Inactive' %>
            </span>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4 fw-bold">Date Created</div>
          <div class="col-md-8">
            <%= new Date(userToView.createdAt).toLocaleString() %>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4 fw-bold">Last Updated</div>
          <div class="col-md-8">
            <%= new Date(userToView.updatedAt).toLocaleString() %>
          </div>
        </div>
        <div class="row">
          <div class="col-md-4 fw-bold">Last Login</div>
          <div class="col-md-8">
            <% if (userToView.lastLogin) { %> <%= new
            Date(userToView.lastLogin).toLocaleString() %> <% } else { %>
            <span class="text-muted fst-italic">Never logged in</span>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <% if (userToView._id.toString() !== currentUser._id.toString()) { %>
    <div class="card shadow-sm border-danger mb-4">
      <div class="card-header bg-light text-danger">
        <h5 class="mb-0">
          <i class="fas fa-exclamation-triangle me-2"></i> Danger Zone
        </h5>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">Delete User Account</h6>
            <p class="text-muted mb-0">
              Permanently remove this user and all associated data
            </p>
          </div>
          <button
            class="btn btn-danger delete-user-btn"
            data-id="<%= userToView._id %>"
            data-name="<%= userToView.name %>"
          >
            <i class="fas fa-trash me-1"></i> Delete User
          </button>
        </div>
      </div>
    </div>
    <% } %>
  </div>
</div>

<!-- Delete User Confirmation Modal -->
<div
  class="modal fade"
  id="deleteUserModal"
  tabindex="-1"
  aria-labelledby="deleteUserModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteUserModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i> Delete User
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <div class="warning-icon">
            <i class="fas fa-user-slash"></i>
          </div>
        </div>
        <p class="fs-5 text-center">
          Are you sure you want to delete <strong id="deleteUserName"></strong>?
        </p>
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-circle me-2"></i>
          This action cannot be undone. The user's account will be permanently
          deleted from the system.
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="fas fa-trash"></i> Delete User
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .page-intro {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  }

  .intro-content {
    display: flex;
    align-items: center;
  }

  .intro-icon {
    font-size: 1.8rem;
    width: 56px;
    height: 56px;
    background-color: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    box-shadow: 0 0.25rem 0.5rem rgba(var(--primary-color-rgb), 0.2);
  }

  .intro-text h2 {
    margin: 0;
    font-weight: 600;
  }

  .intro-text p {
    margin: 0.5rem 0 0;
    color: #6c757d;
  }

  .avatar-circle {
    width: 80px;
    height: 80px;
    background-color: var(--primary-color);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
  }

  .avatar-initials {
    color: white;
    font-size: 32px;
    font-weight: bold;
    line-height: 1;
  }

  .warning-icon {
    font-size: 3.5rem;
    color: #f8bb86;
    margin-bottom: 1rem;
  }

  @media (max-width: 992px) {
    .page-intro {
      flex-direction: column;
      align-items: flex-start;
    }

    .intro-actions {
      margin-top: 1rem;
      align-self: flex-start;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Delete user functionality
    const deleteButtons = document.querySelectorAll(".delete-user-btn");
    const deleteUserModal = new bootstrap.Modal(
      document.getElementById("deleteUserModal")
    );
    const deleteUserName = document.getElementById("deleteUserName");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

    deleteButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const userId = this.getAttribute("data-id");
        const name = this.getAttribute("data-name");

        deleteUserName.textContent = name;
        confirmDeleteBtn.setAttribute("data-id", userId);

        deleteUserModal.show();
      });
    });

    // Confirm delete action
    confirmDeleteBtn.addEventListener("click", async function () {
      const userId = this.getAttribute("data-id");

      try {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        const response = await fetch(`/api/auth/users/${userId}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        });

        const data = await response.json();

        if (data.success) {
          deleteUserModal.hide();

          Swal.fire({
            icon: "success",
            title: "User Deleted",
            text: "The user has been permanently removed from the system.",
            confirmButtonColor: "#28a745",
          }).then(() => {
            window.location.href = "/admin/users";
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Deletion Failed",
            text: data.message || "Failed to delete user",
            confirmButtonColor: "#dc3545",
          });
        }
      } catch (error) {
        console.error("Error:", error);
        Swal.fire({
          icon: "error",
          title: "System Error",
          text: "An unexpected error occurred while deleting the user",
          confirmButtonColor: "#dc3545",
        });
      } finally {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-trash"></i> Delete User';
      }
    });
  });
</script>

<%- include('../components/footer') %>
