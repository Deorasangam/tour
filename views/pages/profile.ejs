<%- include('../components/header', { pageTitle: 'My Profile' }) %>

<div class="page-intro">
  <div class="intro-content">
    <div class="intro-icon">
      <i class="fas fa-user-circle"></i>
    </div>
    <div class="intro-text">
      <h2>My Profile</h2>
      <p>View and update your account information</p>
    </div>
  </div>
  <div class="intro-actions">
    <a href="/admin/dashboard" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>
</div>

<div class="row">
  <div class="col-lg-4">
    <div class="card mb-4">
      <div class="card-body text-center">
        <div class="profile-avatar-container">
          <div class="avatar-circle mx-auto">
            <span class="avatar-initials"
              ><%= user.name.charAt(0).toUpperCase() %></span
            >
          </div>
          <div
            class="profile-status <%= user.isActive ? 'active' : 'inactive' %>"
          ></div>
        </div>
        <h4 class="mt-3"><%= user.name %></h4>
        <p class="text-muted mb-1"><%= user.email %></p>
        <div class="profile-role mt-2">
          <span
            class="badge <%= user.role === 'admin' ? 'badge-primary' : 'badge-info' %>"
          >
            <%= user.role === 'admin' ? 'Administrator' : 'Editor' %>
          </span>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">Account Details</div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <span>User ID</span>
            <span class="text-muted"
              ><%= user._id.toString().substring(0, 8) %>...</span
            >
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <span>Joined</span>
            <span class="text-muted"
              ><%= new Date(user.createdAt).toLocaleDateString() %></span
            >
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <span>Last Login</span>
            <span class="text-muted"
              ><%= user.lastLogin ? new Date(user.lastLogin).toLocaleString() :
              'Never' %></span
            >
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            <span>Status</span>
            <% if (user.isActive) { %>
            <span class="badge badge-success">Active</span>
            <% } else { %>
            <span class="badge badge-secondary">Inactive</span>
            <% } %>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-user-edit mr-2"></i> Edit Profile</h5>
      </div>
      <div class="card-body">
        <form id="profileForm">
          <div class="form-group">
            <label for="name">Full Name</label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              value="<%= user.name %>"
              required
            />
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              class="form-control"
              id="email"
              name="email"
              value="<%= user.email %>"
              required
            />
          </div>

          <div class="form-group">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Update Profile
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-key mr-2"></i> Change Password</h5>
      </div>
      <div class="card-body">
        <form id="passwordForm">
          <div class="form-group">
            <label for="currentPassword">Current Password</label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="currentPassword"
                name="currentPassword"
                required
              />
              <div class="input-group-append">
                <button
                  class="btn btn-outline-secondary toggle-password"
                  type="button"
                  data-toggle="currentPassword"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="newPassword">New Password</label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="newPassword"
                name="newPassword"
                required
              />
              <div class="input-group-append">
                <button
                  class="btn btn-outline-secondary toggle-password"
                  type="button"
                  data-toggle="newPassword"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
            <div class="password-strength mt-2">
              <div class="progress" style="height: 5px">
                <div
                  id="passwordStrength"
                  class="progress-bar"
                  role="progressbar"
                  style="width: 0%"
                  aria-valuenow="0"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <small id="passwordFeedback" class="form-text text-muted"
                >Password strength indicator</small
              >
            </div>
          </div>

          <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <div class="input-group">
              <input
                type="password"
                class="form-control"
                id="confirmPassword"
                name="confirmPassword"
                required
              />
              <div class="input-group-append">
                <button
                  class="btn btn-outline-secondary toggle-password"
                  type="button"
                  data-toggle="confirmPassword"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
            <div id="passwordMatch" class="mt-2"></div>
          </div>

          <div class="form-group">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-key"></i> Change Password
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  .page-intro {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
  }

  .intro-content {
    display: flex;
    align-items: center;
  }

  .intro-icon {
    font-size: 1.8rem;
    width: 56px;
    height: 56px;
    background-color: var(--primary-color);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
  }

  .intro-text h2 {
    margin: 0;
    font-weight: 600;
  }

  .intro-text p {
    margin: 0.5rem 0 0;
    color: #6c757d;
  }

  .profile-avatar-container {
    position: relative;
    display: inline-block;
  }

  .avatar-circle {
    width: 120px;
    height: 120px;
    background-color: var(--primary-color);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .avatar-initials {
    color: white;
    font-size: 48px;
    font-weight: bold;
    line-height: 1;
  }

  .profile-status {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    position: absolute;
    bottom: 10px;
    right: 10px;
    border: 2px solid white;
  }

  .profile-status.active {
    background-color: #28a745;
  }

  .profile-status.inactive {
    background-color: #6c757d;
  }

  .progress-bar.bg-danger {
    background-color: #dc3545 !important;
  }

  .progress-bar.bg-warning {
    background-color: #ffc107 !important;
  }

  .progress-bar.bg-success {
    background-color: #28a745 !important;
  }

  @media (max-width: 992px) {
    .page-intro {
      flex-direction: column;
    }

    .intro-actions {
      margin-top: 1rem;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Handle profile form submission
    const profileForm = document.getElementById("profileForm");
    profileForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = {
        name: document.getElementById("name").value,
        email: document.getElementById("email").value,
      };

      try {
        // Disable form and show loading
        const submitBtn = profileForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Updating...';

        const response = await fetch("/api/users/profile", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        // Re-enable form
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Profile';

        if (data.success) {
          // Show success message
          Swal.fire({
            icon: "success",
            title: "Profile Updated!",
            text: "Your profile has been updated successfully",
            confirmButtonColor: "#28a745",
          });
        } else {
          // Show error message
          Swal.fire({
            icon: "error",
            title: "Update Failed",
            text: data.message || "Failed to update profile",
            confirmButtonColor: "#dc3545",
          });
        }
      } catch (error) {
        console.error("Error:", error);
        // Re-enable form
        const submitBtn = profileForm.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Profile';

        Swal.fire({
          icon: "error",
          title: "System Error",
          text: "An unexpected error occurred while updating profile",
          confirmButtonColor: "#dc3545",
        });
      }
    });

    // Handle password form submission
    const passwordForm = document.getElementById("passwordForm");
    passwordForm.addEventListener("submit", async function (e) {
      e.preventDefault();

      const newPassword = document.getElementById("newPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;

      // Verify passwords match
      if (newPassword !== confirmPassword) {
        Swal.fire({
          icon: "error",
          title: "Passwords Don't Match",
          text: "New password and confirmation must match",
          confirmButtonColor: "#dc3545",
        });
        return;
      }

      const formData = {
        currentPassword: document.getElementById("currentPassword").value,
        newPassword: newPassword,
      };

      try {
        // Disable form and show loading
        const submitBtn = passwordForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Updating...';

        const response = await fetch("/api/users/change-password", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        // Re-enable form
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';

        if (data.success) {
          // Show success message and clear form
          Swal.fire({
            icon: "success",
            title: "Password Changed!",
            text: "Your password has been updated successfully",
            confirmButtonColor: "#28a745",
          });

          passwordForm.reset();
          document.getElementById("passwordStrength").style.width = "0%";
          document.getElementById("passwordStrength").className =
            "progress-bar";
          document.getElementById("passwordFeedback").textContent =
            "Password strength indicator";
          document.getElementById("passwordMatch").innerHTML = "";
        } else {
          // Show error message
          Swal.fire({
            icon: "error",
            title: "Password Update Failed",
            text: data.message || "Failed to update password",
            confirmButtonColor: "#dc3545",
          });
        }
      } catch (error) {
        console.error("Error:", error);
        // Re-enable form
        const submitBtn = passwordForm.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-key"></i> Change Password';

        Swal.fire({
          icon: "error",
          title: "System Error",
          text: "An unexpected error occurred while changing password",
          confirmButtonColor: "#dc3545",
        });
      }
    });

    // Toggle password visibility
    const toggleButtons = document.querySelectorAll(".toggle-password");
    toggleButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const targetId = this.getAttribute("data-toggle");
        const input = document.getElementById(targetId);

        if (input.type === "password") {
          input.type = "text";
          this.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
          input.type = "password";
          this.innerHTML = '<i class="fas fa-eye"></i>';
        }
      });
    });

    // Password strength meter
    const newPasswordInput = document.getElementById("newPassword");
    const passwordStrength = document.getElementById("passwordStrength");
    const passwordFeedback = document.getElementById("passwordFeedback");

    newPasswordInput.addEventListener("input", function () {
      const password = this.value;
      const strength = calculatePasswordStrength(password);

      passwordStrength.style.width = strength.score + "%";
      passwordStrength.className = "progress-bar " + strength.class;
      passwordFeedback.textContent = strength.feedback;

      // Check if passwords match when typing
      checkPasswordsMatch();
    });

    // Password match indicator
    const confirmPasswordInput = document.getElementById("confirmPassword");
    const passwordMatch = document.getElementById("passwordMatch");

    confirmPasswordInput.addEventListener("input", checkPasswordsMatch);

    function checkPasswordsMatch() {
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      if (confirmPassword.length === 0) {
        passwordMatch.innerHTML = "";
        return;
      }

      if (newPassword === confirmPassword) {
        passwordMatch.innerHTML =
          '<div class="text-success"><i class="fas fa-check-circle"></i> Passwords match</div>';
      } else {
        passwordMatch.innerHTML =
          '<div class="text-danger"><i class="fas fa-times-circle"></i> Passwords do not match</div>';
      }
    }

    function calculatePasswordStrength(password) {
      // Default values
      let score = 0;
      let className = "bg-danger";
      let feedback = "Password is too weak";

      if (!password) {
        return { score: 0, class: "", feedback: "Password strength indicator" };
      }

      // Calculate score based on various criteria
      if (password.length >= 8) score += 20;
      if (password.length >= 12) score += 10;
      if (/[A-Z]/.test(password)) score += 20;
      if (/[a-z]/.test(password)) score += 10;
      if (/[0-9]/.test(password)) score += 20;
      if (/[^A-Za-z0-9]/.test(password)) score += 20;

      // Determine feedback based on score
      if (score >= 80) {
        className = "bg-success";
        feedback = "Password is strong";
      } else if (score >= 50) {
        className = "bg-warning";
        feedback = "Password is moderate";
      }

      return {
        score: score,
        class: className,
        feedback: feedback,
      };
    }
  });
</script>

<%- include('../components/footer') %>
